import string

import numpy as np
import pandas as pd
from sklearn.feature_extraction.text import CountVectorizer


def linear(filename):
    df = create_df(filename)
    # convert the label from strings to binary values
    df.label[df.label != 'safeware'] = 1
    df.label[df.label == 'safeware'] = 0
    # balance dataset
    fracs = {0: 1 / 15, 1: 1 / 25}
    df_balanced = balance_df(df, fracs)
    print(df_balanced.groupby('label').describe())
    # clean text
    df_balanced['features'] = df_balanced['features'].apply(text_process)
    # Transform features collumn for one hot encoding
    df_balanced = df_balanced.drop('features', 1).join(df_balanced.features.str.join('|').str.get_dummies())
    df_balanced['label'] = df_balanced['label'].astype('int')
    return df_balanced.drop('label', axis=1), np.array(df_balanced['label'])


def linear_family(filename):
    df = create_df(filename)
    # removes non malware
    df = df[df.label != 'safeware']
    # filter less than 20
    df = df[df.groupby('label').label.transform(len) >= 20]
    # clean text
    df['features'] = df['features'].apply(text_process)
    # Transform features collumn for one hot encoding
    df_balanced = df.drop('features', 1).join(df.features.str.join('|').str.get_dummies())
    df_balanced['label'] = df_balanced['label']
    return df_balanced.drop('label', axis=1), np.array(df_balanced['label'])


def bayes(filename):
    df = create_df(filename)
    # convert the label from strings to binary values
    df.label[df.label != 'safeware'] = 1
    df.label[df.label == 'safeware'] = 0
    # balance dataset
    fracs = {0: 1 / 15, 1: 1 / 25}
    df_balanced = balance_df(df, fracs)
    df_balanced['label'] = df_balanced['label'].astype('int')
    # clean text
    # transform the data into occurrences,
    # which will be the features that we will feed into the model
    count_vect = CountVectorizer()
    counts = count_vect.fit_transform(df_balanced['features'])
    return counts, np.array(df_balanced['label'])


def bayes_family(filename):
    df = create_df(filename)
    # removes non malware
    df = df[df.label != 'safeware']
    # filter less than 20
    df = df[df.groupby('label').label.transform(len) >= 20]
    print(df.groupby('label').describe())
    # transform the data into occurrences,
    # which will be the features that we will feed into the model
    count_vect = CountVectorizer()
    counts = count_vect.fit_transform(df['features'])
    return counts, np.array(df['label'])


def create_df(filename):
    # create a data frame with pandas
    df = pd.read_table(filename, sep='\t', header=None, names=['label', 'features'])
    # removes all NaN values
    df = df.dropna()
    return df


def balance_df(df, fracs):
    rand = np.random.RandomState([42])
    return pd.concat(
        dff.sample(n=int(fracs.get(i) * len(df)), replace=True, random_state=rand) for i, dff in df.groupby('label'))


def text_process(mess):
    # Check characters to see if they are in punctuation
    nopunc = [char for char in mess if char not in string.punctuation]
    # Join the characters again to form the string.
    nopunc = ''.join(nopunc)
    # Remove any stopwords
    return nopunc.split()
