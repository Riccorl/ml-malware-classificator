import argparse
import sys
import atexit
from datetime import timedelta
from time import time, strftime, localtime

from sklearn import linear_model
from sklearn import naive_bayes
from sklearn import svm

import constants as const
import data_cleaner as dc
import data_reader
import model

ClassifierMap = {
    'MultinomialNB': [naive_bayes.MultinomialNB(), 'MultinomialNB'],
    'BernoulliNB': [naive_bayes.BernoulliNB(), 'BernoulliNB'],
    'SGDC': [linear_model.SGDClassifier(), 'SGDClassifier'],
    'LinearSVC': [svm.LinearSVC(max_iter=2000), 'LinearSVC'],
    'SVM': [svm.SVC(kernel='linear',class_weight='balanced', probability=True), 'SVM']
}

start = time()


def seconds_to_str(elapsed=None):
    if elapsed is None:
        return strftime("%Y-%m-%d %H:%M:%S", localtime())
    else:
        return str(timedelta(seconds=elapsed))


def log(s, f, elapsed=None):
    line = "=" * 40
    print(line, file=f)
    print(seconds_to_str(), '-', s, file=f)
    if elapsed:
        print("Elapsed time:", elapsed, file=f)
    print(line, file=f)
    print('', file=f)


def endlog(f):
    end = time()
    elapsed = end - start
    log("End Program", f, seconds_to_str(elapsed))


def main():
    f = open('execution-log.txt', 'w')
    parser = argparse.ArgumentParser(description='Android Malware Classificator')
    parser.add_argument('method', type=str,
                        help='NaiveBayes=MultinomialNB, SGDC=SGDClassifier, LinearSVC=LinearSVC, SVM=SVM')
    parser.add_argument('--type', type=str, default='class')
    parser.add_argument('-s', type=str, help='Feature subset', default='S6 S7')
    args = parser.parse_args()

    if args.method not in ClassifierMap.keys():
        print("Method ", args.method, " not available.")
        sys.exit(1)

    print('Generate the data set...', file=f)
    filename = data_reader.generate_data(const.BIG_DATA, args.s.split())

    # Select data cleaner based on classifier
    if args.method[1] == 'MultinomialNB':
        cleaner = dc.clean_data_bayes
    else:
        cleaner = dc.clean_data_linear
    classifier = ClassifierMap[args.method][0]

    X, y = cleaner(filename)
    print('Train and evaluation of the model...', file=f)
    # START Mesure execution time
    atexit.register(endlog, f)
    log("Start Program", f)
    # END Mesure execution time
    accuracy, precision, recall, fscore = model.validation(classifier, X, y)
    print('Accuracy: ' + repr(accuracy), file=f)
    print('Precision: ' + repr(precision), file=f)
    print('Recall: ' + repr(recall), file=f)
    print('F1 score: ' + repr(fscore), file=f)
    f.close()


# def main():
#     print('Generate the data set...')
#     filename = data_reader.generate_data(const.BIG_DATA, ['S2','S6', 'S7'])
#     X, y = dc.clean_data_bayes(filename)
#     # X, y = dc.clean_data_linear_family(filename)
#     print('Train and evaluation of the model...')
#     # START Mesure execution time
#     atexit.register(endlog)
#     log("Start Program")
#     # END Mesure execution time
#     classifier = ClassifierMap['MultinomialNB'][0]
#     accuracy, precision, recall, fscore = model.validation(classifier, X, y)
#     print('Accuracy: ' + repr(accuracy))
#     print('Precision: ' + repr(precision))
#     print('Recall: ' + repr(recall))
#     print('F1 score: ' + repr(fscore))


if __name__ == '__main__':
    main()
